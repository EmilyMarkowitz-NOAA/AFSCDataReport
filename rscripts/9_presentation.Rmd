---
title: "`r title0`"
subtitle: "`r paste0('NOAA Technical Memorandum NMFS-[', office0, ']-', reportnum0, ' ', months(Sys.Date()), ' ', as.numeric(format(as.Date(Sys.Date(),'%Y-%m-%d'),'%Y')) )` "
author: "`r authors0`"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    seal: false
    css: [default, noaa, noaa-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
  powerpoint_presentation:
    reference_doc: presentation_NOAATemplate.pptx
---

layout: true
background-image: url(/rpresentation/www/noaa_fisheries_small.png)
background-position: 0% 100%;
background-size: 10%


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  dev = "svg",
  fig.width = 12,
  fig.height = 7, 
  fig.retina = 3
  )
```

class: inverse, center, middle

background-image: url(/rpresentation/TitleBackground_boat)
background-size: cover

# `r title0 `

## `r paste0('NOAA Technical Memorandum NMFS-[', office0, ']-', reportnum0, ' ', months(Sys.Date()), ' ', as.numeric(format(as.Date(Sys.Date(),'%Y-%m-%d'),'%Y')) )`

`r Sys.Date()`

`r authors0 `


---


##### Study Purpose


```{r}

placenames <- read.csv(file = system.file("data", 
                                          file = "placenames.csv", package = "akgfmaps", 
                                          mustWork = TRUE), stringsAsFactors = FALSE) %>% 
  transform_data_frame_crs(out.crs = sf::st_crs(reg_dat$survey.strata))

# Time
dates.mo<-as.numeric(unique(substr(x = as.character(dat.maxyr$dates), 
                 start = 1, stop = 2)))

months.words<-c("January", "February",	"March", "April", 
                "May", "June", "July", "August", 
                "September", "October", "November", "December")

```

From `r months.words[min(dates.mo)]` to `r months.words[max(dates.mo)]` `r maxyr`, the National Marine Fisheries Service’s Alaska Fisheries Science Center Resource Assessment and Conservation Engineering Division conducted its `r yrofsurvey ``r stndth` annual `r SURVEY ` (`r SRVY `) continental shelf bottom trawl survey of groundfish and invertebrate fauna. The standard study area encompasses a major portion of the `r SRVY ` shelf (depths between `r min(dat.maxyr$BOT_DEPTH)` and `r max(dat.maxyr$BOT_DEPTH)` m) from the Alaska Peninsula north to approximately the latitude of St. Matthew Island (60º 50' N). Two stern trawlers, the `r text_list(paste0(unique(dat.maxyr$VESSEL_M), "-m ", unique(dat.maxyr$VESSEL_NAME)))`, were chartered for sampling during the `r SRVY ` survey. Demersal populations of fishes and invertebrates were sampled by trawling for 30 minutes at 37.04 × 37.04 km (20 × 20 nmi) stations centered within a stratified systematic grid consisting of a total of `r length(unique(dat.maxyr$STATION))` stations in the `r SRVY ` survey. At each station, species composition of the catch was determined, and length distributions and age structure samples were collected from ecologically and commercially important species. All survey stations were sampled successfully in the `r SRVY `. 

> How do I know if all stations were sampled successfully? Data-wise?
> need to code "from the Alaska Peninsula north to approximately the latitude of St. Matthew Island (60º 50' N)"

```{r}

# Find mean of sst and bt by year
sst<-aggregate(x = dat$SURF_TEMP, by = list("Year" = dat$YEAR), FUN = mean, na.rm=T)
bt<-aggregate(x = dat$BOT_TEMP, by = list("Year" = dat$YEAR), FUN = mean, na.rm=T)

# Find mean of sst and bt for whole time series (using mean by year)
sst.mean<-mean(sst$x, na.rm = T)
bt.mean<-mean(bt$x, na.rm = T)

# Is SST or BT now warmer than the mean SST or BT of the whole timeseries?
sst.TF<- (sst$x > sst.mean)
bt.TF<- (bt$x > bt.mean)

waswarmer.TF<-data.frame("SST" = sst.TF, "BT" = bt.TF)
waswarmer.TF$TF<-((waswarmer.TF$SST+waswarmer.TF$BT)==2)

temp<-ifelse(sum(waswarmer.TF$TF[1:2])>2, 
 paste0("for the ", numbers2words_th(x = length(1:(which(waswarmer.TF$TF %in% FALSE)[1]-1)), 
                                     type = "word"), " consecutive year,"), 
 "the")


```


```{r}

# find number of ___ for species

spp.tsn.list0<-spp.tsn.list[names(spp.tsn.list) %in% 
                              unique(dat$SCIENTIFIC.y[dat$YEAR %in% maxyr])]

unq.spp<-xunits(length(findhowmanyspp(spp.tsn.list0, ranklvl = "species") ))

unq.gen<-xunits(length(findhowmanyspp(spp.tsn.list0, ranklvl = "genus") ))

unq.fam<-xunits(length(findhowmanyspp(spp.tsn.list0, ranklvl = "family") ))

# unq.phyl<-xunits(length(findhowmanyspp(spp.tsn.list0, ranklvl = "phyla") )) 

spp.tsn.list00<-spp.tsn.list0[names(spp.tsn.list0) %in% unique(dat.maxyr$SCIENTIFIC.y[dat.maxyr$category %in% invert])]

unq.spp.inv<-xunits(length(findhowmanyspp(spp.tsn.list00, ranklvl = "species") ))  
    
unq.phyl.inv<-xunits(length(findhowmanyspp(spp.tsn.list00, ranklvl = "phylum") ))  

```

In the `r SURVEY`, `r temp` average surface (`r round(x = mean(dat.maxyr$SURF_TEMP, na.rm = T), digits = 1) `°C) and bottom (`r round(x = mean(dat.maxyr$BOT_TEMP, na.rm = T), digits = 1) `°C) water temperatures for the `r SRVY ` shelf were well above the long-term means from `r minyr` to `r maxyr` for the surface (`r round(x = mean(dat$SURF_TEMP[dat$YEAR %in% (min(dat$YEAR)):maxyr], na.rm = T), digits = 1) `°C) and for the bottom (`r round(x = mean(dat$BOT_TEMP[dat$YEAR %in% (min(dat$YEAR)):maxyr], na.rm = T), digits = 1) `°C). In the `r SRVY `, there were a total of `r unq.spp` species representing `r unq.fam` families and `r unq.gen` genera, as well as `r unq.spp.inv ` invertebrate taxa representing `r unq.phyl.inv` phyla, identified in the catches.


Survey results presented herein include abundance estimates for fishes and invertebrates, geographic distributions and abundance-at-length of the more common fish species, and summary surface and bottom temperature data during the summer survey period. Appendices provide station data, summarized catch data by station, species listings, and detailed analyses of abundance and biological data of the sampled populations.



 - Develop alternative approaches to measure national and regional fishery outputs for productivity measurements.
 - Evaluate the impacts of missing data and other issues on output estimates. 

![](C:/Users/Emii/Documents/Homework/FisheriesEconomicProductivityIndex/rpresentation/MapOfUS.jpg)


???

Here we want to Develop alternative approaches to measure fishery outputs for productivity measurements for the US and for each of the 7 regions.
To do that appropriately, we really needed to explore the impacts of missing data and other issues on output estimates.



```{r, echo=FALSE, warning=FALSE, include = FALSE}


dir.pres<-"C:/Users/Emii/Documents/Homework/FisheriesEconomicProductivityIndex/rpresentation/"
dir.output<-"C:/Users/Emii/Documents/Homework/FisheriesEconomicProductivityIndex/output/"
Date0<-"2020-08-21"
datadl<-"2020-08-14"
# knitr::include_graphics(paste0(dir.pres, "/MapOfUS.JPG"))
  library(tidyverse)
  library(gapminder)
  library(scales)
  library(gridExtra)
  library(patchwork)

print4plots<-function(plotlist, datadl, title00){

  
  b1<-plotlist[1][[1]]
  b2<-plotlist[2][[1]]
  b3<-plotlist[3][[1]]
  b4<-plotlist[4][[1]]
  b<-plotlist
  layout <- (b1 + b2) / (b3 + b4)
  
  title0<-strsplit(split = "_", x = names(b)[1])[[1]][-c(1,2)]
  title0<-title0[-length(title0)]
  title0<-gsub(pattern = "byr", replacement = "base yr = ", x = title0)
  title0<-paste(title0, collapse = " ")
  title0<-gsub(pattern = " P ", replacement = " Price Method ", x = title0)
  title0<-gsub(pattern = " Q ", replacement = " Quantity Method ", x = title0)
  
  layout +
    plot_annotation(
    title = title00, 
    subtitle = title0,
    caption = paste0("Data downloaded from FOSS ", datadl),
    theme = theme(plot.title = element_text(size = 20, hjust = 0.5, face = "bold"))
    )
}

plotnlines<-function(dat, title00, place){
  
  xnames<-as.numeric(paste0(dat$Year))
  xnames[!(xnames %in% seq(from = min((as.numeric(xnames))),
                           to = max(as.numeric(xnames)),
                           by = 10))]<-""
  
  dat$val<-as.numeric(as.character(dat$val))
  dat$val[(is.infinite(dat$val))]<-NA
  divideby<-paste0("(", strsplit(x = xunits(mean(dat$val, na.rm = T)), split = " ")[[1]][2], "s)")
  if (divideby %in% "(trillions)") {
    divideby0<-1e12
  } else if (divideby %in% "(billions)") {
    divideby0<-1e9
  } else if (divideby %in% "(millions)") {
    divideby0<-1e6
  } else if (divideby %in% "(thousands)") {
    divideby0<-1e3
  } else if (divideby %in% "(NAs)") {
    divideby0<-1
    divideby<-""
  }
  
  dat$val<-dat$val/divideby0
  # ynames<-as.numeric(paste0(val))
  
  g<-ggplot(data = dat, aes(x = factor(Year), y = val, color = cat)) +
    geom_line(aes(group = cat)) +
    geom_point() +
    theme(
      # legend.position = c(0.9, 0.2), 
      panel.grid.major.y = element_line( color=NOAALightBlue, size = .1 ),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.line = element_line( color=NOAALightBlue, size = .1 ),
      axis.ticks = element_blank(), # remove ticks
      panel.background = element_blank()
    )  + 
    ylab(paste0(gsub(pattern = "_", replacement = "", 
                    x = strsplit(x = title00, split = "-")[[1]][1]), 
               " ", divideby)) +
    xlab("Year") +
    scale_x_discrete(labels= xnames) +
    # scale_y_discrete(labels= ynames) +
    guides(fill=FALSE) + 
    ggtitle(paste0(place))
  
  return(g)
}

xunits<-function(temp00, combine=T) {
  
  temp00<-sum(as.numeric(temp00))
  sigfig<-format(temp00, digits = 3, scientific = TRUE)
  sigfig0<-as.numeric(substr(x = sigfig, start = (nchar(sigfig)-1), stop = nchar(sigfig)))
  
  if (sigfig0<=5) {
    # if (sigfig0<4) {
    unit<-""
    x<-format(x = temp00, big.mark = ",", digits = 0, scientific = F)
    # } else if (sigfig0>=4 & sigfig0<6) {
    #   unit<-" thousand"
    # x<-round(temp00/1e3, digits = 1)
    # } else if (sigfig0==5) {
    #   unit<-" thousand"
    #   x<-round(temp00/1e3, digits = 0)
  } else if (sigfig0>=6 & sigfig0<9) {
    unit<-" million"
    x<-round(temp00/1e6, digits = 1)
  } else if (sigfig0>=9 & sigfig0<12) {
    unit<-" billion"
    x<-round(temp00/1e9, digits = 1)
  } else if (sigfig0>=12) {
    unit<-" trillion"
    x<-round(temp00/1e12, digits = 1)
  }
  
  out<-ifelse(combine==T, paste0(x, unit), list(x, unit))
  
  return(out)
}

NOAALightBlue<-"#C9E1E6"
NOAADarkBlue<-"#0098A6"
NOAADarkGrey<-"#56575A" #text
NOAABlueScale<-colorRampPalette(colors = c(NOAALightBlue, NOAADarkBlue))

```

---


##### Study Purpose

 - Develop alternative approaches to measure national and regional fishery outputs for productivity measurements.
 - Evaluate the impacts of missing data and other issues on output estimates. 

![](C:/Users/Emii/Documents/Homework/FisheriesEconomicProductivityIndex/rpresentation/MapOfUS.jpg)


???

Here we want to Develop alternative approaches to measure fishery outputs for productivity measurements for the US and for each of the 7 regions.
To do that appropriately, we really needed to explore the impacts of missing data and other issues on output estimates.


```{r}
library(tibble)
library(magrittr)
library(glue)


info<-data.frame("img_loc" = paste0(list.files(list.files(path = (list.files(path = dir.output, pattern = as.character(Date0), full.names = TRUE)), 
                                               full.names = TRUE, pattern = "analyses"), full.names = TRUE), "/figures/"),
                 "figname" = list.files(list.files(path = (list.files(path = dir.output, pattern = as.character(Date0), full.names = TRUE)), 
                                               full.names = TRUE, pattern = "analyses"), full.names = FALSE))

info<-info[!(info$figname %in% c("2007To2017_Fisheries_Northeast",  "SummaryFiles")),]

  title0<-strsplit(split = "_", x = info$figname)
  info$timeframe<-unlist(lapply(title0, `[[`, 1))
  info$categories<-unlist(lapply(title0, `[[`, 2))
  info$method<-unlist(lapply(title0, `[[`, 3))
  info$categorysplittype<-unlist(lapply(title0, `[[`, 4))
  info$pctmiss<-gsub(pattern = "pctmiss", replacement = "", x = unlist(lapply(title0, `[[`, 5)))
  info$slidetitle = paste0("Regional Quantitiy Index")
  info$slidesubtitle = paste0(ifelse(info$method=="P", "Price", "Quantity"), " Method, ", 
                              gsub(pattern = "To", replacement = "-", x = info$timeframe))
  
# for (ii in ) {
  fig.list.atl<-list()
  fig.list.pac<-list()
  fig.list.ne<-list()
  for (i in 1:nrow(info)) {
    if (length(list.files(path = paste0(info$img_loc[i]), pattern = "AllFigures.rdata")) != 0) {
      load(file = paste0(info$img_loc[i], "AllFigures.rdata")) #figure.list
      temp<-figures.list[grep(pattern = "QI-Line", x = names(figures.list), ignore.case = T)]
      
    #Atl
      fig.list.atl<-c(fig.list.atl, list(print4plots(plotlist = temp[1:4], datadl = datadl, title00 = paste0(info$figname[i], " Atlantic"))))
      names(fig.list.atl)[length(fig.list.atl)]<-paste0(info$figname[i], " Atlantic")
    #Pac
      fig.list.pac<-c(fig.list.pac, list(print4plots(plotlist = temp[6:9], datadl = datadl, title00 = paste0(info$figname[i], " Pacific"))))
      names(fig.list.pac)[length(fig.list.pac)]<-paste0(info$figname[i], " Pacific")
    #NE
      fig.list.ne<-c(fig.list.ne, temp[5])
      names(fig.list.ne)[length(fig.list.ne)]<-paste0(info$figname[i])
    } else {
      fig.list.atl<-c(fig.list.atl, list("NA"))
      fig.list.pac<-c(fig.list.pac, list("NA"))
      fig.list.ne<-c(fig.list.ne, list("NA"))
      names(fig.list.atl)[length(fig.list.atl)]<-names(fig.list.pac)[length(fig.list.pac)]<-names(fig.list.ne)[length(fig.list.ne)]<-"x"
    }
  }
  
  info$atl<-names(fig.list.atl)
  info$pac<-names(fig.list.pac)
  info$ne<-names(fig.list.ne)
  info$img_loc_atl<-paste0(dir.pres, "/atl/", info$atl, ".jpg")
  info$img_loc_pac<-paste0(dir.pres, "/pac/", info$pac, ".jpg")
  info$img_loc_ne<-paste0(dir.pres, "/ne/", info$ne, ".jpg")
  
  dir.create(paste0(dir.pres, "atl"))
  for (i in 1:length(fig.list.atl)) {
    file_name = paste0(dir.pres, "atl/", names(fig.list.atl)[i], ".jpg")
    jpeg(filename = file_name)
    print(fig.list.atl[[i]])
    dev.off()
  }
  
    dir.create(paste0(dir.pres, "pac"))
  for (i in 1:length(fig.list.pac)) {
    file_name = paste0(dir.pres, "pac/", names(fig.list.pac)[i], ".jpg")
    jpeg(filename = file_name)
    print(fig.list.pac[[i]])
    dev.off()
  }
    
      dir.create(paste0(dir.pres, "ne"))
  for (i in 1:length(fig.list.pac)) {
    file_name = paste0(dir.pres, "ne/", names(fig.list.ne)[i], ".jpg")
    jpeg(filename = file_name)
    print(fig.list.ne[[i]])
    dev.off()
}
  
  
# }
# slides<-c()
#   for (i in 1:nrow(info))
# slides<-paste0(slides, 
# "
#   ### ",info$slidetitle[1],"
#   
#   ",info$slidesubtitle[1],"
# 
#   ```{r}
#   get(fig.list[1])
#   ```
# 
#   ")
  info<-info[!(info$atl %in% "x"),]
  
slides_info <- tibble::as_tibble(info)

slides_text <- glue_data(
  slides_info,
  "
  ### {slidetitle}

  {slidesubtitle}

  ![]({img_loc_atl})

  ---

  ### {slidetitle}

  {slidesubtitle}

  ![]({img_loc_pac})

  "
)


slides_text_ne <- glue_data(
  slides_info,
  "
  ### {slidetitle}

  {slidesubtitle}

  ![]({img_loc_ne})

  "
)

#  print(fig.list.atl[names(fig.list.atl) %in% {info$atl}])


# for(cyls in sort(unique(mtcars$cyl))) {
#     cat(paste0("## ", cyls, " cylinders\n\n"))
#     p = mtcars %>%
#         filter(cyl == cyls) %>% 
#         ggplot(aes(x = mpg, y = hp)) +
#         geom_point() +
#         labs(title = paste(cyls,"cylinders"))
#     print(p)
# 
#     cat("\n\n---------------------\n\n")
# }
# 

```

--- 

#### Regional Data

---

####

`r slides_text %>% paste(collapse = "\n---\n")`

---

#### Northeast Data

---

####

`r slides_text_ne %>% paste(collapse = "\n---\n")`


```{r, results='asis'}
# for(i in 1:nrow(info)) {
#     cat(paste0("## ", info$slidetitle, " \n\n", info$slidesubtitle," \n\n"))
#     print(fig.list.atl[i])
# 
#     cat("\n\n---------------------\n\n")
# }

```


---


### Regional Quantity Index 1950-2019 FS 1

```{r, echo = FALSE, warnings = FALSE, out.width=700, out.height=400}
outputrun<-list.files(path = dir.output, pattern = as.character(Date0), full.names = TRUE)
a<-list.files(path = (list.files(path = paste0(outputrun, "/analyses/"), full.names = TRUE))[1], 
                   pattern = "figures", full.names = TRUE, ignore.case = TRUE)
# b<-load(paste0(a, "/AllFigures.rdata"))
load(file = paste0(a, "/AllFigures.rdata"))
b<-figures.list[grep(pattern = "QI-Line", x = names(figures.list), ignore.case = T)]

print4plots(plotlist = b[1:4], datadl = datadl, title00 = "Regional Quantity Index 1950-2019 FS 1")

```

### Regional Quantity Index 1950-2019 FS 2

```{r, echo =  FALSE, out.width=550, out.height=300}
print4plots(plotlist = b[6:9], datadl = datadl, title00 = "Regional Quantity Index 1950-2019 FS 2")
```

### Regional Quantity Index 1997-2019 FS 1

```{r, echo = FALSE, warnings = FALSE}
outputrun<-list.files(path = dir.output, pattern = as.character(Date0), full.names = TRUE)
a<-list.files(path = (list.files(path = paste0(outputrun, "/analyses/"), full.names = TRUE))[1], 
                   pattern = "figures", full.names = TRUE, ignore.case = TRUE)
# b<-load(paste0(a, "/AllFigures.rdata"))
load(file = paste0(a, "/AllFigures.rdata"))
b<-figures.list[grep(pattern = "QI-Line", x = names(figures.list), ignore.case = T)]

print4plots(plotlist = b[1:4], datadl = datadl, title00 = "Regional Quantity Index 1997-2019 FS 1")

```

---

### Regional Quantity Index 1997-2019 FS 2

```{r, echo =  FALSE, out.width=550, out.height=300}
print4plots(plotlist = b[6:9], datadl = datadl, title00 = "Regional Quantity Index 1997-2019 FS 2")
```

---

### Quantity Index

```{r, echo =  FALSE, out.width=550, out.height=300}
# outputrun<-list.files(path = dir.output, pattern = as.character(Date0), full.names = TRUE)
# a<-list.files(path = paste0(outputrun, "/analyses/SummaryFiles/"), 
#                                  pattern = ".rdata", full.names = TRUE, ignore.case = TRUE)
#   
# # b<-load(paste0(a, "/AllFigures.rdata"))
# load(file = a)
# 
# b<-list()
# for (i in 1:length(summarydata)) {
# dat<-summarydata[i][[1]]
# dat<-dat[, c(which(names(dat) %in% "QEI"), grep(pattern = " categoryorigFSO FS)", x = names(dat)))]
# dat<-dat[, c(which(names(dat) %in% "QEI"), grep(pattern = "QI ", x = names(dat)))]
# dat0<-data.frame("Year" = rownames(dat), dat )
# names(dat0)[-1]<-names(dat)
# 
#   
#   a <- gather(dat0, Category, val, QEI:names(dat0)[ncol(dat0)], factor_key=TRUE)
#   
#   a$cat<-a$Category
#   
#   temp0<-a
#   
# 
#   g<-plotnlines(dat = temp0, title00 = names(summarydata)[1], place  = names(summarydata)[1]) 
# 
# 
# 
# b<-c(b, list(g))
# names(b)[length(b)]<-names(summarydata)[1]
# 
# }
# 
# print4plots(plotlist = b, datadl = datadl, title00 = "")

```

---

```{r dev = 'svg', dev.args = list(bg = "transparent")}
#https://arm.rbind.io/slides/xaringan.html#100
invthm <- theme_minimal() + 
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA), 
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.background = element_rect(fill = "transparent", colour = NA),
    legend.key = element_rect(fill = "transparent", colour = NA),
    text = element_text(colour = "white"),
    axis.text = element_text(colour = "white")
  )
```

```{r dev = 'svg', dev.args = list(bg = "transparent")}
name_plot + invthm
```

---


### Where can you find me?

* email: Emily.Markowitz@noaa.gov
* github: https://github.com/alexadibenedetto
* linkedin: https://www.linkedin.com/in/alexadibenedetto/

